<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Dashboard - FoodieExpress</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
      <h1>üë®‚Äçüíº Admin Dashboard</h1>
      <nav>
        <a href="index.html">Home</a>
        <a href="logout.php">Logout</a>
      </nav>
    </header>
    <div class="container">
      <h2>Welcome, Admin!</h2>
      <p>
        Here you can manage orders, view users, and perform administrative
        tasks.
      </p>
      <nav class="admin-tabs">
        <button id="tab-restaurant">Restaurant Management</button>
        <button id="tab-menu">Menu Management</button>
        <button id="tab-orders">Order Handling</button>
      </nav>
      <div id="section-restaurant" class="admin-section">
        <h3>Restaurant Management</h3>
        <form action="admin_restaurant.php" method="POST" enctype="multipart/form-data">
          <input type="text" name="restaurant_name" placeholder="Restaurant Name" required /><br />
          <input type="text" name="location" placeholder="Location" required /><br />
          <input type="file" name="image" accept="image/*" required /><br />
          <button type="submit">Add Restaurant</button>
        </form>
        <div id="admin-restaurant-list-section">
          <h4>All Restaurants</h4>
          <ul id="admin-restaurant-list"></ul>
        </div>
      </div>
      <div id="section-menu" class="admin-section" style="display:none;">
        <h3>Add Menu Item</h3>
        <form id="menu-item-form" action="admin_menu.php" method="POST" enctype="multipart/form-data">
          <select name="restaurant_id" id="restaurant-select" required>
            <option value="">Select Restaurant</option>
          </select><br />
          <input type="text" name="item_name" placeholder="Menu Item Name" required /><br />
          <input type="number" name="price" placeholder="Price" step="0.01" required /><br />
          <input type="file" name="image" accept="image/*" required /><br />
          <input type="text" name="description" placeholder="Description" required /><br />
          <button type="submit">Add Menu Item</button>
        </form>
        <div id="admin-menu-list-section">
          <h4>All Menu Items</h4>
          <ul id="admin-menu-list"></ul>
        </div>
      </div>
      <div id="section-orders" class="admin-section" style="display:none;">
        <h3>Order Handling</h3>
        <div id="orders-list"></div>
      </div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Tab switching logic
        const sections = ['restaurant', 'menu', 'orders'];
        function showSection(section) {
          sections.forEach(s => {
            document.getElementById('section-' + s).style.display = (s === section) ? '' : 'none';
          });
        }
        document.getElementById('tab-restaurant').onclick = () => showSection('restaurant');
        document.getElementById('tab-menu').onclick = () => { showSection('menu'); fetchMenuItems(); };
        document.getElementById('tab-orders').onclick = () => { showSection('orders'); fetchOrders(); };
        showSection('restaurant');
        // Restaurant dropdown for menu item form
        fetch("admin_menu.php")
          .then((response) => response.json())
          .then((data) => {
            const select = document.getElementById("restaurant-select");
            select.innerHTML = '<option value="">Select Restaurant</option>';
            data.forEach((restaurant) => {
              const option = document.createElement("option");
              option.value = restaurant.id;
              option.textContent = restaurant.name;
              select.appendChild(option);
            });
            // Populate admin restaurant list
            const adminList = document.getElementById("admin-restaurant-list");
            adminList.innerHTML = '';
            data.forEach((restaurant) => {
              const li = document.createElement("li");
              li.textContent = restaurant.name + " (" + restaurant.location + ") ";
              const delBtn = document.createElement("button");
              delBtn.textContent = "Delete";
              delBtn.onclick = function () {
                if (confirm("Are you sure you want to delete this restaurant?")) {
                  fetch("admin_restaurant.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: "delete_restaurant_id=" + encodeURIComponent(restaurant.id),
                  })
                    .then((res) => {
                      if (res.ok) {
                        alert("Restaurant deleted successfully.");
                        location.reload();
                      } else {
                        alert("Failed to delete restaurant.");
                      }
                    });
                }
              };
              li.appendChild(delBtn);
              adminList.appendChild(li);
            });
          });
        // Fetch menu items for menu management
        function fetchMenuItems() {
          fetch('get_menu.php?restaurant_id=all')
            .then(res => res.json())
            .then(menu => {
              const menuList = document.getElementById('admin-menu-list');
              menuList.innerHTML = '';
              if (!menu.length) {
                menuList.innerHTML = '<li>No menu items found.</li>';
                return;
              }
              menu.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item.name + ' - $' + item.price + ' (' + (item.description || '') + ')';
                menuList.appendChild(li);
              });
            });
        }
        // Fetch orders for order handling
        function fetchOrders() {
          fetch('admin_orders.php')
            .then(res => res.json())
            .then(orders => {
              let html = '';
              if (!orders.length) html = '<p>No orders found.</p>';
              else {
                html += '<table border="1" style="width:100%;border-collapse:collapse;"><tr><th>ID</th><th>User</th><th>Address</th><th>Items</th><th>Total</th><th>Status</th><th>Action</th></tr>';
                orders.forEach(order => {
                  html += `<tr><td>${order.id}</td><td>${order.username}</td><td>${order.address}</td><td><ul>`;
                  order.items.forEach(item => {
                    html += `<li>${item.item_name} x${item.quantity} - $${item.price}</li>`;
                  });
                  html += `</ul></td><td>$${order.total}</td><td>${order.status}</td><td>`;
                  if (order.status === 'pending') {
                    html += `<button onclick="updateOrder(${order.id},'confirmed')">Accept</button> <button onclick="updateOrder(${order.id},'rejected')">Reject</button>`;
                  } else {
                    html += order.status.charAt(0).toUpperCase() + order.status.slice(1);
                  }
                  html += '</td></tr>';
                });
                html += '</table>';
              }
              document.getElementById('orders-list').innerHTML = html;
            });
        }
        window.updateOrder = function(orderId, status) {
          const formData = new FormData();
          formData.append('order_id', orderId);
          formData.append('status', status);
          fetch('admin_orders.php', {
            method: 'POST',
            body: formData
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              fetchOrders();
            } else {
              alert(data.error || 'Failed to update order.');
            }
          });
        }
      });
    </script>
  </body>
</html>
